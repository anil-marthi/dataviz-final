<!DOCTYPE html>
<html>
	<head>
		<style>
			.states {
			  fill: lightblue;
			}

			.states :hover {
			  fill: grey;
			}

			.state-borders {
			  fill: none;
			  stroke: black;
			  stroke-width: 0.5px;
			  stroke-linejoin: round;
			  stroke-linecap: round;
			  pointer-events: none;
			}

			.labels {
			  fill: blue;
			  font-weight: bold;
			  font-family:arial;
			  font-size:0.6em;
			}

			.points {
			  height: 5px;
			  width: 5px;
			  border-radius: 50%;
			  display: inline-block;
			  stroke: red;
			  fill: red;
			}

			#legend text {
			  font-size: 0.9em;
			  color: #333;
			  font-weight: 400;
			}

			div.tooltip {
			  color: #222; 
			  background: #fff; 
			  border-radius: 3px; 
			  box-shadow: 0px 0px 2px 0px #a6a6a6; 
			  padding: .2em; 
			  text-shadow: #f5f5f5 0 1px 0;
			  opacity: 0.9; 
			  position: absolute;
			}
			</style>
		<script src="https://d3js.org/d3.v4.min.js"></script>
		<script src="https://d3js.org/topojson.v3.min.js"></script>
		<script src="https://d3js.org/queue.v1.min.js"></script>
		<script src="https://d3js.org/d3-scale-chromatic.v1.min.js"></script>
		<script>
			function geometry(transform, latitude, longitude, name) {
				position = [((longitude - transform.translate[0])/transform.scale[0]), ((latitude - transform.translate[1])/transform.scale[1])];
				return {
						type: "Point",
						coordinates: position,
						properties: {
							name: name
							}
						};
			}

			function geometries(transform, stateCoords) {
				var geometries = [];
				stateCoords.forEach(state => { if (state.state != "PR" && state.state != "DC") { geometries.push(geometry(transform, state.latitude, state.longitude, state.state)) }});
				return {
						type: "GeometryCollection",
						geometries: geometries
						}
			}

			function splitCasesIntoNParts(data, n) {
				var x = findMinCases(data);
				var y = 220000; //Using this number instead of findMaxCases(data) due to large gap of covid cases between top 4 and other states;

				if (n == 1) { return []; }
				var result = [], delta = Number.parseInt((y - x)/(n - 1));
				if (delta <= 1) {
					return [];
				}
				while (x < y) {
					result.push(x);
					x += delta;
				}
				result.push(y);
				return result;
			}

			function findMinCases(data) {
				var min = +data[0].cases;
				for (index in data) {
					var stateName = data[index].state;
					if (stateName == "Virgin Islands" || stateName == "Puerto Rico" || stateName == "Guam" || stateName == "Northern Mariana Islands") {
						continue;
					}
					var cases = +data[index].cases;
					if (cases < min) { min = cases; }
				}
				return min;
			}

			function findMaxCases(data) {
				var max = +data[0].cases;
				for (index in data) {
					var cases = +data[index].cases;
					if (cases > max) { max = cases; }
				}
				return max;
			}

			function ready(error, us, covidData, stateCoords) {
				if (error) throw error;
			
				const width = 960;
				var projection = d3.geoAlbersUsa().scale(1275).translate([475, 300]);
				var path1 = d3.geoPath().projection(projection);
				var svg = d3.select("svg");
				var path = d3.geoPath();
				var tooltip = d3.select("div.tooltip");

				const filteredData = covidData.filter(row => row["date"] == "2020-08-01");

				var stateCovidMap = {};
				for (index in filteredData) {
					stateCovidMap[filteredData[index].state] = [filteredData[index].cases, filteredData[index].deaths];
				}

				const domainCases = splitCasesIntoNParts(filteredData, 8);
				const legendColors = d3.schemeOranges[8];
				var legendColor = d3.scaleThreshold()
					.domain(domainCases)
					.range(legendColors);

				us.objects.states.geometries.forEach(state => {
							state.properties["totalCases"] = stateCovidMap[state.properties["name"]][0];
							state.properties["totalDeaths"] = stateCovidMap[state.properties["name"]][1];
						});
				us.objects.places = geometries(us.transform, stateCoords);

				svg.append("g")
					.attr("class", "states")
					.selectAll("path")
					.data(topojson.feature(us, us.objects.states).features)
					.enter().append("path")
					.attr("d", path)
					.attr("fill", (d, i) => legendColor(d.properties.totalCases))
					.on("mouseover", (d, i) => {
							tooltip.transition().duration(200).style("opacity", 0.9);
							return tooltip.style("hidden", false)
								.style("left", (d3.event.pageX + 20)+"px")
								.style("top", (d3.event.pageY - 20)+"px")
								.html("<b>" + d.properties.name + "<br/>" + "Total Cases: " + d.properties.totalCases + "<br/>" + "Total Deaths: " + d.properties.totalDeaths + "</b>");
					})
					.on("mousemove", (d, i) => {
							tooltip.transition().duration(200).style("opacity", 0.9);
							return tooltip.style("hidden", false)
								.style("left", (d3.event.pageX + 20)+"px")
								.style("top", (d3.event.pageY - 20)+"px")
								.html("<b>" + d.properties.name + "<br/>" + "Total Cases:  " + d.properties.totalCases + "<br/>" + "Total Deaths: " + d.properties.totalDeaths + "</b>");
					})

					.on("mouseout", (d, i) => {
							tooltip.transition().duration(200).style("opacity", 0);
							tooltip.style("hidden", true).html('');
					});

				svg.append("path")
					.attr("class", "state-borders")
					.attr("d", path(topojson.mesh(us, us.objects.states, (a, b) => a !== b )));

				svg.selectAll(".labels")
					.data(topojson.feature(us, us.objects.places).features)
					.enter()
					.append("text")
					.attr("class", "labels")
					.text((d, i) => d.properties.name)
					.attr("x", (d, i) => path1.centroid(d)[0])
					.attr("y", (d, i) => path1.centroid(d)[1]);
				
				var legend = svg.append("g")
					.attr("id", "legend");

				var legenditem = legend.selectAll(".legenditem")
					.data(d3.range(7))
					.enter()
					.append("g")
					.attr("class", "legenditem")
					.attr("transform", (d, i) => "translate(" + i * 50 + ",40)");

				legenditem.append("rect")
					.attr("x", width - 400)
					.attr("y", -10)
					.attr("width", 50)
					.attr("height", 6)
					.attr("class", "rect")
					.style("fill", (d, i) => legendColors[i] );

				legenditem.append("text")
					.attr("x", width - 400)
					.attr("y", -15)
					.text((d, i) => Math.ceil(domainCases[i]/1000) + "K" );
			}
		</script>
	</head>
	<body>
		<div>
			<h1>US States Total Covid Cases</h1>
			<div id="next"><b>click <a href="second.html">Next</a> for comparision between states' covid data</b>
			</div>
			<svg width="1000" height="600"></svg>
			<div class="tooltip"></div>
			<h3>Source: New York Times</h3>
		</div>

		<script>
			queue()
				.defer(d3.json, "https://d3js.org/us-10m.v2.json")
				.defer(d3.csv, "us-states.csv")
				.defer(d3.tsv, "us-states-coordinates.tsv")
				.await(ready);
			
		</script>
	</body>
</html>